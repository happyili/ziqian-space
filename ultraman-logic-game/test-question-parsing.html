<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢˜ç›®è§£æå•å…ƒæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-case { margin: 15px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #007cba; background: #f8f9fa; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .test-btn { background: #007cba; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .test-btn:hover { background: #005a8b; }
        .test-stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; min-width: 120px; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #007cba; }
        .stat-label { font-size: 0.9rem; color: #666; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 0.85rem; }
        .json-display { background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; font-family: 'Courier New', monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ§ª é¢˜ç›®è§£æå•å…ƒæµ‹è¯•</h1>
    
    <div class="test-stats">
        <div class="stat-card">
            <div class="stat-number" id="total-tests">0</div>
            <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="passed-tests">0</div>
            <div class="stat-label">é€šè¿‡</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="failed-tests">0</div>
            <div class="stat-label">å¤±è´¥</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="success-rate">0%</div>
            <div class="stat-label">æˆåŠŸç‡</div>
        </div>
    </div>
    
    <div>
        <button class="test-btn" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button class="test-btn" onclick="runJSONTests()">æµ‹è¯•JSONè§£æ</button>
        <button class="test-btn" onclick="runLegacyTests()">æµ‹è¯•æ–‡æœ¬è§£æ</button>
        <button class="test-btn" onclick="runValidationTests()">æµ‹è¯•éªŒè¯é€»è¾‘</button>
        <button class="test-btn" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
    </div>
    
    <div id="test-results"></div>
    
    <!-- åŠ è½½è„šæœ¬ -->
    <script src="config/gameConfig.js"></script>
    <script src="config/questionTemplates.js"></script>
    <script src="js/llmIntegration.js"></script>
    
    <script>
        const testResults = document.getElementById('test-results');
        let testStats = { total: 0, passed: 0, failed: 0 };
        
        // æµ‹è¯•æ•°æ®
        const testCases = {
            validJSON: {
                name: 'æœ‰æ•ˆçš„JSONæ ¼å¼',
                input: `{
  "story": "å¥¥ç‰¹æ›¼åœ¨å®‡å®™ä¸­å‘ç°äº†ä¸€ä¸ªç¥ç§˜çš„æ•°å­—åºåˆ—ï¼š2, 4, 8, 16, ?",
  "question": "ä¸‹ä¸€ä¸ªæ•°å­—åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ",
  "options": ["20", "24", "32", "64"],
  "correctAnswer": "C",
  "explanation": "è¿™æ˜¯ä¸€ä¸ªç­‰æ¯”æ•°åˆ—ï¼Œæ¯ä¸ªæ•°å­—éƒ½æ˜¯å‰ä¸€ä¸ªæ•°å­—çš„2å€",
  "hint": "è§‚å¯Ÿæ¯ä¸ªæ•°å­—ä¹‹é—´çš„å€æ•°å…³ç³»"
}`,
                shouldPass: true
            },
            
            jsonWithMarkdown: {
                name: 'Markdownä»£ç å—ä¸­çš„JSON',
                input: `\`\`\`json
{
  "story": "å¥¥ç‰¹æ›¼é‡åˆ°äº†å›¾æ¡ˆåºåˆ—ï¼šğŸ”´ğŸ”µğŸ”´ğŸ”µğŸ”´",
  "question": "ä¸‹ä¸€ä¸ªå›¾æ¡ˆåº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ",
  "options": ["ğŸ”´", "ğŸ”µ", "ğŸŸ¡", "ğŸŸ¢"],
  "correctAnswer": "B",
  "explanation": "è¿™æ˜¯ä¸€ä¸ªäº¤æ›¿å‡ºç°çš„æ¨¡å¼",
  "hint": "è§‚å¯Ÿé¢œè‰²çš„äº¤æ›¿è§„å¾‹"
}
\`\`\``,
                shouldPass: true
            },
            
            validLegacyFormat: {
                name: 'æœ‰æ•ˆçš„æ–‡æœ¬æ ¼å¼',
                input: `æ•…äº‹ï¼šå¥¥ç‰¹æ›¼åœ¨æˆ˜æ–—ä¸­å‘ç°äº†ä¸€ä¸ªé€»è¾‘è°œé¢˜ï¼šå¦‚æœAå¤§äºBï¼ŒBå¤§äºCï¼Œé‚£ä¹ˆAå’ŒCçš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ
é¢˜ç›®ï¼šæ ¹æ®ç»™å®šæ¡ä»¶ï¼ŒAå’ŒCçš„å…³ç³»æ˜¯ï¼Ÿ
é€‰é¡¹Aï¼šAå¤§äºC
é€‰é¡¹Bï¼šAå°äºC
é€‰é¡¹Cï¼šAç­‰äºC
é€‰é¡¹Dï¼šæ— æ³•ç¡®å®š
æ­£ç¡®ç­”æ¡ˆï¼šA
è§£é¢˜æ€è·¯ï¼šæ ¹æ®ä¼ é€’æ€§ï¼Œå¦‚æœA>Bä¸”B>Cï¼Œé‚£ä¹ˆA>C
æç¤ºï¼šæƒ³æƒ³æ•°å­¦ä¸­çš„å¤§å°å…³ç³»ä¼ é€’æ€§`,
                shouldPass: true
            },
            
            invalidJSON: {
                name: 'æ— æ•ˆçš„JSONæ ¼å¼',
                input: `{
  "story": "å¥¥ç‰¹æ›¼çš„æ•…äº‹",
  "question": "ä»€ä¹ˆé—®é¢˜ï¼Ÿ"
  // ç¼ºå°‘é€‰é¡¹å’Œç­”æ¡ˆ
}`,
                shouldPass: false,
                expectedError: 'é€‰é¡¹å¿…é¡»æ˜¯åŒ…å«4ä¸ªå…ƒç´ çš„æ•°ç»„'
            },
            
            missingFields: {
                name: 'ç¼ºå°‘å¿…éœ€å­—æ®µ',
                input: `{
  "story": "å¥¥ç‰¹æ›¼çš„æ•…äº‹",
  "options": ["A", "B", "C", "D"],
  "correctAnswer": "A"
}`,
                shouldPass: false,
                expectedError: 'ç¼ºå°‘æˆ–æ— æ•ˆçš„é¢˜ç›®å­—æ®µ'
            },
            
            invalidAnswer: {
                name: 'æ— æ•ˆçš„æ­£ç¡®ç­”æ¡ˆ',
                input: `{
  "story": "å¥¥ç‰¹æ›¼çš„æ•…äº‹",
  "question": "ä»€ä¹ˆé—®é¢˜ï¼Ÿ",
  "options": ["é€‰é¡¹1", "é€‰é¡¹2", "é€‰é¡¹3", "é€‰é¡¹4"],
  "correctAnswer": "E"
}`,
                shouldPass: false,
                expectedError: 'æ­£ç¡®ç­”æ¡ˆå¿…é¡»æ˜¯Aã€Bã€Cã€Dä¹‹ä¸€'
            },
            
            incompleteOptions: {
                name: 'é€‰é¡¹æ•°é‡ä¸è¶³',
                input: `{
  "story": "å¥¥ç‰¹æ›¼çš„æ•…äº‹",
  "question": "ä»€ä¹ˆé—®é¢˜ï¼Ÿ",
  "options": ["é€‰é¡¹1", "é€‰é¡¹2"],
  "correctAnswer": "A"
}`,
                shouldPass: false,
                expectedError: 'é€‰é¡¹å¿…é¡»æ˜¯åŒ…å«4ä¸ªå…ƒç´ çš„æ•°ç»„'
            },
            
            emptyFields: {
                name: 'ç©ºå­—æ®µæµ‹è¯•',
                input: `{
  "story": "",
  "question": "ä»€ä¹ˆé—®é¢˜ï¼Ÿ",
  "options": ["é€‰é¡¹1", "é€‰é¡¹2", "é€‰é¡¹3", "é€‰é¡¹4"],
  "correctAnswer": "A"
}`,
                shouldPass: false,
                expectedError: 'ç¼ºå°‘æˆ–æ— æ•ˆçš„æ•…äº‹å­—æ®µ'
            },
            
            legacyIncomplete: {
                name: 'ä¸å®Œæ•´çš„æ–‡æœ¬æ ¼å¼',
                input: `æ•…äº‹ï¼šå¥¥ç‰¹æ›¼çš„æ•…äº‹
é¢˜ç›®ï¼šä»€ä¹ˆé—®é¢˜ï¼Ÿ
é€‰é¡¹Aï¼šé€‰é¡¹1
é€‰é¡¹Bï¼šé€‰é¡¹2
// ç¼ºå°‘é€‰é¡¹Cå’ŒD`,
                shouldPass: false,
                expectedError: 'é¢˜ç›®æ ¼å¼ä¸å®Œæ•´'
            }
        };
        
        function clearResults() {
            testResults.innerHTML = '';
            testStats = { total: 0, passed: 0, failed: 0 };
            updateStats();
        }
        
        function updateStats() {
            document.getElementById('total-tests').textContent = testStats.total;
            document.getElementById('passed-tests').textContent = testStats.passed;
            document.getElementById('failed-tests').textContent = testStats.failed;
            const successRate = testStats.total > 0 ? Math.round((testStats.passed / testStats.total) * 100) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
        }
        
        function addTestResult(testName, passed, details, error = null) {
            const section = document.createElement('div');
            section.className = 'test-case';
            
            const resultClass = passed ? 'success' : 'error';
            const resultIcon = passed ? 'âœ…' : 'âŒ';
            
            let content = `
                <h4>${resultIcon} ${testName}</h4>
                <div class="test-result ${resultClass}">
                    <strong>${passed ? 'é€šè¿‡' : 'å¤±è´¥'}</strong>
                    ${details ? `<br><small>${details}</small>` : ''}
                </div>
            `;
            
            if (error) {
                content += `<div class="test-result error">
                    <strong>é”™è¯¯ä¿¡æ¯:</strong> ${error}
                </div>`;
            }
            
            section.innerHTML = content;
            testResults.appendChild(section);
            
            testStats.total++;
            if (passed) {
                testStats.passed++;
            } else {
                testStats.failed++;
            }
            updateStats();
        }
        
        function runSingleTest(testName, testCase) {
            try {
                const llm = new LLMIntegration();
                const result = llm.parseQuestionResponse(testCase.input);
                
                if (testCase.shouldPass) {
                    // éªŒè¯è§£æç»“æœçš„å®Œæ•´æ€§
                    if (result.story && result.question && result.options.length === 4 && result.correctAnswer) {
                        addTestResult(testName, true, `æˆåŠŸè§£æé¢˜ç›®ï¼Œæ•…äº‹é•¿åº¦: ${result.story.length}å­—ç¬¦`);
                    } else {
                        addTestResult(testName, false, 'è§£æç»“æœä¸å®Œæ•´', 'ç¼ºå°‘å¿…éœ€å­—æ®µ');
                    }
                } else {
                    // ä¸åº”è¯¥é€šè¿‡çš„æµ‹è¯•å´é€šè¿‡äº†
                    addTestResult(testName, false, 'æµ‹è¯•åº”è¯¥å¤±è´¥ä½†å´æˆåŠŸäº†', 'é¢„æœŸå¤±è´¥ä½†å®é™…æˆåŠŸ');
                }
            } catch (error) {
                if (testCase.shouldPass) {
                    // åº”è¯¥é€šè¿‡ä½†å¤±è´¥äº†
                    addTestResult(testName, false, 'è§£æå¤±è´¥', error.message);
                } else {
                    // é¢„æœŸå¤±è´¥
                    const expectedError = testCase.expectedError || '';
                    const actualError = error.message;
                    const errorMatches = !expectedError || actualError.includes(expectedError);
                    
                    if (errorMatches) {
                        addTestResult(testName, true, `æ­£ç¡®æ•è·äº†é¢„æœŸé”™è¯¯: ${actualError}`);
                    } else {
                        addTestResult(testName, false, `é”™è¯¯ä¿¡æ¯ä¸åŒ¹é…ï¼Œé¢„æœŸ: "${expectedError}"ï¼Œå®é™…: "${actualError}"`);
                    }
                }
            }
        }
        
        function runAllTests() {
            clearResults();
            
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = '<h2>ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</h2>';
            testResults.appendChild(section);
            
            for (const [key, testCase] of Object.entries(testCases)) {
                runSingleTest(testCase.name, testCase);
            }
            
            // æ·»åŠ æ€§èƒ½æµ‹è¯•
            runPerformanceTest();
        }
        
        function runJSONTests() {
            clearResults();
            
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = '<h2>ğŸ“„ JSONæ ¼å¼è§£ææµ‹è¯•</h2>';
            testResults.appendChild(section);
            
            const jsonTests = ['validJSON', 'jsonWithMarkdown', 'invalidJSON', 'missingFields', 'invalidAnswer', 'incompleteOptions', 'emptyFields'];
            
            for (const testKey of jsonTests) {
                if (testCases[testKey]) {
                    runSingleTest(testCases[testKey].name, testCases[testKey]);
                }
            }
        }
        
        function runLegacyTests() {
            clearResults();
            
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = '<h2>ğŸ“ æ–‡æœ¬æ ¼å¼è§£ææµ‹è¯•</h2>';
            testResults.appendChild(section);
            
            const legacyTests = ['validLegacyFormat', 'legacyIncomplete'];
            
            for (const testKey of legacyTests) {
                if (testCases[testKey]) {
                    runSingleTest(testCases[testKey].name, testCases[testKey]);
                }
            }
        }
        
        function runValidationTests() {
            clearResults();
            
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = '<h2>ğŸ” éªŒè¯é€»è¾‘æµ‹è¯•</h2>';
            testResults.appendChild(section);
            
            // æµ‹è¯•è¾¹ç•Œæƒ…å†µ
            const boundaryTests = [
                {
                    name: 'è¶…é•¿æ–‡æœ¬å¤„ç†',
                    input: `{
  "story": "${'å¥¥ç‰¹æ›¼'.repeat(100)}",
  "question": "ä»€ä¹ˆé—®é¢˜ï¼Ÿ",
  "options": ["A", "B", "C", "D"],
  "correctAnswer": "A"
}`,
                    shouldPass: true
                },
                {
                    name: 'ç‰¹æ®Šå­—ç¬¦å¤„ç†',
                    input: `{
  "story": "å¥¥ç‰¹æ›¼é‡åˆ°äº†ç‰¹æ®Šç¬¦å·ï¼š@#$%^&*()!",
  "question": "è¿™äº›ç¬¦å·çš„è§„å¾‹æ˜¯ä»€ä¹ˆï¼Ÿ",
  "options": ["è§„å¾‹1", "è§„å¾‹2", "è§„å¾‹3", "è§„å¾‹4"],
  "correctAnswer": "B"
}`,
                    shouldPass: true
                },
                {
                    name: 'æ•°å­—ç±»å‹ç­”æ¡ˆ',
                    input: `{
  "story": "å¥¥ç‰¹æ›¼çš„æ•…äº‹",
  "question": "ä»€ä¹ˆé—®é¢˜ï¼Ÿ",
  "options": ["é€‰é¡¹1", "é€‰é¡¹2", "é€‰é¡¹3", "é€‰é¡¹4"],
  "correctAnswer": 1
}`,
                    shouldPass: false,
                    expectedError: 'æ­£ç¡®ç­”æ¡ˆå¿…é¡»æ˜¯Aã€Bã€Cã€Dä¹‹ä¸€'
                }
            ];
            
            for (const testCase of boundaryTests) {
                runSingleTest(testCase.name, testCase);
            }
        }
        
        function runPerformanceTest() {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = '<h2>âš¡ æ€§èƒ½æµ‹è¯•</h2>';
            testResults.appendChild(section);
            
            const llm = new LLMIntegration();
            const testInput = testCases.validJSON.input;
            const iterations = 100;
            
            const startTime = performance.now();
            for (let i = 0; i < iterations; i++) {
                llm.parseQuestionResponse(testInput);
            }
            const endTime = performance.now();
            
            const avgTime = (endTime - startTime) / iterations;
            
            addTestResult(
                'è§£ææ€§èƒ½æµ‹è¯•',
                avgTime < 10, // æœŸæœ›æ¯æ¬¡è§£æå°äº10ms
                `${iterations}æ¬¡è§£æå¹³å‡è€—æ—¶: ${avgTime.toFixed(2)}ms`
            );
        }
        
        // é¡µé¢åŠ è½½åæ˜¾ç¤ºæµ‹è¯•è¯´æ˜
        document.addEventListener('DOMContentLoaded', () => {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.innerHTML = `
                <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
                <p>è¿™ä¸ªæµ‹è¯•å¥—ä»¶ç”¨äºéªŒè¯é¢˜ç›®è§£æåŠŸèƒ½çš„æ­£ç¡®æ€§å’Œå¥å£®æ€§ã€‚åŒ…æ‹¬ä»¥ä¸‹æµ‹è¯•ç±»åˆ«ï¼š</p>
                <ul>
                    <li><strong>JSONè§£ææµ‹è¯•</strong>ï¼šéªŒè¯æ–°çš„JSONæ ¼å¼è§£æåŠŸèƒ½</li>
                    <li><strong>æ–‡æœ¬è§£ææµ‹è¯•</strong>ï¼šéªŒè¯å…¼å®¹çš„æ–‡æœ¬æ ¼å¼è§£æåŠŸèƒ½</li>
                    <li><strong>éªŒè¯é€»è¾‘æµ‹è¯•</strong>ï¼šæµ‹è¯•æ•°æ®éªŒè¯å’Œè¾¹ç•Œæƒ…å†µå¤„ç†</li>
                    <li><strong>æ€§èƒ½æµ‹è¯•</strong>ï¼šç¡®ä¿è§£ææ€§èƒ½æ»¡è¶³è¦æ±‚</li>
                </ul>
                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•ã€‚</p>
            `;
            testResults.appendChild(section);
        });
    </script>
</body>
</html>
